<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Giỏ hàng</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="" th:href="@{/css/giohang.css}">
    <link rel="icon" type="image/png" th:href="@{/logonewT.png}">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

</head>
<body>
<div th:replace="~{part/header :: header}"></div>
<div th:replace="~{part/dropdowns :: dropdowns}"></div>

<main>
    <div class="container mt-4">
        <nav style="--bs-breadcrumb-divider: '/';" aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/" style="text-decoration: none; color: #1a73e8;">Trang chủ</a></li>
                <li class="breadcrumb-item active" aria-current="page">Giỏ hàng</li>
            </ol>
        </nav>

        <div id="cart-content">
            <!-- Khi có sản phẩm -->
            <div class="cart-container" id="cart-items-container" th:unless="${cartItems == null or #lists.isEmpty(cartItems)}">
                <div class="row">
                    <!-- Danh sách sản phẩm (bên trái) -->
                    <div class="col-lg-8 col-md-12">
                        <div class="cart-header">
                            <h3>
                                <input type="checkbox" id="select-all" checked>
                                <label for="select-all">Chọn tất cả (<span th:text="${cartItems != null ? cartItems.size() : 0}"></span>)</label>
                            </h3>
                        </div>

                        <!-- Danh sách sản phẩm -->
                        <div th:each="item, iterStat : ${cartItems}">
                            <div class="cart-item">
                                <div class="cart-item-left">
                                    <input type="checkbox" th:id="'item-checkbox-' + ${item.id}" th:data-product-id="${item.product.id}" th:data-unit-id="${item.donViTinh?.id}" checked>
                                    <img th:src="${item.product.mainImageUrl != null ? item.product.mainImageUrl : '/images/placeholder.png'}" alt="Product Image" style="margin-left: 20px">
                                    <div class="cart-item-details">
                                        <h6 th:text="${item.product.tenSanPham} ?: 'Sản phẩm không xác định'"></h6>
                                        <div class="cart-item-actions d-flex align-items-center gap-2">
                                            <div class="quantity-selector">
                                                <button th:onclick="'decreaseQuantity(' + ${item.product.id} + ',' + ${item.donViTinh?.id} + ')'">−</button>
                                                <input type="text" th:id="'quantity-' + ${item.product.id} + '-' + ${item.donViTinh?.id}" th:value="${item.quantity}" readonly>
                                                <button th:onclick="'increaseQuantity(' + ${item.product.id} + ',' + ${item.donViTinh?.id} + ')'">+</button>
                                            </div>
                                            <select class="unit-selector" th:id="'unit-' + ${item.product.id} + '-' + ${item.donViTinh?.id}">
                                                <option th:value="${item.donViTinh?.id}" th:text="${item.donViTinh?.donViTinh} ?: 'N/A'" selected></option>
                                                <!-- Thêm các tùy chọn khác nếu cần -->
                                            </select>
                                            <button class="btn-remove" th:onclick="'removeItem(' + ${item.id} + ')'">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </div>
                                        <p class="discount-info" th:if="${item.donViTinh?.discount != null}">
                                            Giảm ngay <span th:text="${item.donViTinh.discount} + '%'"></span>, áp dụng đến 30/04
                                        </p>
                                    </div>
                                </div>
                                <div class="cart-item-right">
                                    <p class="unit-price mb-0" th:id="'unit-price-' + ${item.product.id} + '-' + ${item.donViTinh?.id}"
                                       th:text="${item.price}"></p>
                                    <div class="cart-item-price" th:id="'price-' + ${item.product.id} + '-' + ${item.donViTinh?.id}"
                                         th:text="${item.itemTotalPrice}"></div>
                                </div>
                            </div>
                            <hr class="item-divider" th:unless="${iterStat.last}"/>
                        </div>

                        <!-- Thêm thông báo lỗi nếu có -->
                        <div th:if="${error != null}" class="alert alert-danger mt-3" th:text="${error}"></div>
                    </div>

                    <!-- Tổng cộng (bên phải) -->
                    <div class="col-lg-4 col-md-12">
                        <div class="cart-summary">
                            <h5>Tổng cộng</h5>
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="total-label">Tổng tiền gốc:</span>
                                <span class="total" id="cart-total" th:text="${#numbers.formatDecimal(originalCartTotal, 0, 'COMMA', 0, 'POINT')} + 'đ'"></span>
                            </div>
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="total-label">Giảm giá trực tiếp:</span>
                                <span class="total" id="direct-discount" style="color: #f7941d;" th:text="'-' + ${#numbers.formatDecimal(directDiscount, 0, 'COMMA', 0, 'POINT')} + 'đ'"></span>
                            </div>
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="total-label">Giảm giá voucher:</span>
                                <span class="total" id="voucher-discount" style="color: #f7941d;" th:text="'-' + ${#numbers.formatDecimal(voucherDiscount, 0, 'COMMA', 0, 'POINT')} + 'đ'"></span>
                            </div>
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <span class="total-label">Tiết kiệm được:</span>
                                <span class="total" id="total-savings" style="color: #f7941d;" th:text="${#numbers.formatDecimal(totalSavings, 0, 'COMMA', 0, 'POINT')} + 'đ'"></span>
                            </div>
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <span class="total-label">Thanh toán:</span>
                                <span class="total" id="final-total" th:text="${#numbers.formatDecimal(finalTotal, 0, 'COMMA', 0, 'POINT')} + 'đ'"></span>
                            </div>
                            <div>
                                <button class="btn btn-checkout" id="checkout-button">Mua hàng</button>
                            </div>
                            <p class="text-muted mt-2 small">
                                Bằng việc tiến hành đặt mua hàng, bạn đồng ý với
                                <a href="#" style="color: #1a73e8; text-decoration: none;">Điều khoản dịch vụ</a> và
                                <a href="#" style="color: #1a73e8; text-decoration: none;">Chính sách xử lý dữ liệu cá nhân</a>
                            </p>
                        </div>
                    </div>


                </div>
            </div>

            <!-- Khi giỏ hàng trống -->
            <div class="empty-cart" id="empty-cart" th:if="${cartItems == null or #lists.isEmpty(cartItems)}">
                <i class="bi bi-cart-x"></i>
                <h4>Giỏ hàng của bạn đang trống</h4>
                <p>Hãy thêm sản phẩm để tiếp tục mua sắm!</p>
                <a href="/" class="btn btn-primary">Quay lại trang chủ</a>
            </div>

            <!-- Modal Mua hàng -->
            <div class="modal fade" id="checkoutModal" tabindex="-1" aria-labelledby="checkoutModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="checkoutModalLabel">
                                <i class="bi bi-cart-check"></i> Xác nhận đơn hàng
                            </h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <div class="row">
                                <!-- Bên trái: Thông tin đơn hàng -->
                                <div class="col-md-6">
                                    <div class="modal-section">
                                        <h6><i class="bi bi-box-seam"></i> Thông tin đơn hàng</h6>
                                        <div id="modal-order-items">
                                            <!-- Danh sách sản phẩm sẽ được thêm bằng JavaScript -->
                                        </div>
                                        <hr class="order-summary-divider">
                                        <div class="summary-row">
                                            <span>Tổng tiền gốc:</span>
                                            <span id="modal-cart-total" th:text="${#numbers.formatDecimal(originalCartTotal, 0, 'COMMA', 0, 'POINT')} + 'đ'"></span>
                                        </div>
                                        <div class="summary-row">
                                            <span>Giảm giá trực tiếp:</span>
                                            <span id="modal-direct-discount" style="color: #f7941d;" th:text="'-' + ${#numbers.formatDecimal(directDiscount, 0, 'COMMA', 0, 'POINT')} + 'đ'"></span>
                                        </div>
                                        <div class="summary-row">
                                            <span>Giảm giá voucher:</span>
                                            <span id="modal-voucher-discount" style="color: #f7941d;" th:text="'-' + ${#numbers.formatDecimal(voucherDiscount, 0, 'COMMA', 0, 'POINT')} + 'đ'"></span>
                                        </div>
                                        <div class="summary-row">
                                            <span>Tiết kiệm được:</span>
                                            <span id="modal-total-savings" style="color: #f7941d;" th:text="${#numbers.formatDecimal(totalSavings, 0, 'COMMA', 0, 'POINT')} + 'đ'"></span>
                                        </div>
                                        <div class="summary-row total">
                                            <span>Thanh toán:</span>
                                            <span id="modal-final-total" th:text="${#numbers.formatDecimal(finalTotal, 0, 'COMMA', 0, 'POINT')} + 'đ'"></span>
                                        </div>
                                    </div>
                                </div>
                                <!-- Bên phải: Thông tin khách hàng và Phương thức thanh toán -->
                                <div class="col-md-6">
                                    <div class="modal-section">
                                        <h6>
                                            <i class="bi bi-person"></i> Thông tin khách hàng
                                            <button type="button" class="btn btn-link btn-sm" id="edit-customer-info" style="float: right;">
                                                <i class="bi bi-pencil"></i> Chỉnh sửa
                                            </button>
                                        </h6>
                                        <div class="form-group">
                                            <label for="customer-name">Họ và tên <span style="color: #dc3545;">*</span></label>
                                            <input type="text" id="customer-name" class="form-control" placeholder="Nhập họ và tên" readonly>
                                            <div class="error-message">Vui lòng nhập họ và tên.</div>
                                        </div>
                                        <div class="form-group">
                                            <label for="customer-phone">Số điện thoại <span style="color: #dc3545;">*</span></label>
                                            <input type="tel" id="customer-phone" class="form-control" placeholder="Nhập số điện thoại" readonly>
                                            <div class="error-message">Vui lòng nhập số điện thoại hợp lệ.</div>
                                        </div>
                                        <div class="form-group">
                                            <label for="province">Tỉnh/Thành phố <span style="color: #dc3545;">*</span></label>
                                            <select id="province" class="form-control" disabled>
                                                <option value="">Chọn Tỉnh/Thành phố</option>
                                            </select>
                                            <div class="error-message">Vui lòng chọn Tỉnh/Thành phố.</div>
                                        </div>
                                        <div class="form-group">
                                            <label for="district">Quận/Huyện <span style="color: #dc3545;">*</span></label>
                                            <select id="district" class="form-control" disabled>
                                                <option value="">Chọn Quận/Huyện</option>
                                            </select>
                                            <div class="error-message">Vui lòng chọn Quận/Huyện.</div>
                                        </div>
                                        <div class="form-group">
                                            <label for="ward">Xã/Phường <span style="color: #dc3545;">*</span></label>
                                            <select id="ward" class="form-control" disabled>
                                                <option value="">Chọn Xã/Phường</option>
                                            </select>
                                            <div class="error-message">Vui lòng chọn Xã/Phường.</div>
                                        </div>
                                        <div class="form-group">
                                            <label for="customer-address-detail">Địa chỉ chi tiết <span style="color: #dc3545;">*</span></label>
                                            <input type="text" id="customer-address-detail" class="form-control" placeholder="Nhập số nhà, tên đường" readonly>
                                            <div class="error-message">Vui lòng nhập địa chỉ chi tiết.</div>
                                        </div>
                                        <!-- Nút Lưu và Hủy chỉnh sửa, ẩn mặc định -->
                                        <div id="edit-controls" style="display: none; margin-top: 10px;">
                                            <button type="button" class="btn btn-primary btn-sm" id="save-customer-info">Lưu</button>
                                            <button type="button" class="btn btn-secondary btn-sm" id="cancel-edit">Hủy chỉnh sửa</button>
                                        </div>
                                    </div>

                                    <div class="modal-section">
                                        <h6><i class="bi bi-credit-card"></i> Phương thức thanh toán</h6>
                                        <div class="form-group">
                                            <label for="payment-method">Chọn phương thức</label>
                                            <select id="payment-method" class="form-control">
                                                <option value="cod">Thanh toán khi nhận hàng (COD)</option>
                                                <option value="bank">Chuyển khoản ngân hàng</option>
                                                <option value="payos">Thanh toán qua PayOS</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-cancel" data-bs-dismiss="modal">Hủy</button>
                            <button type="button" class="btn btn-confirm" id="confirm-order">Xác nhận</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

<div th:replace="~{part/footer :: footer}"></div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script th:inline="javascript">
    // Hàm định dạng giá tiền
    function formatPrice(price) {
        if (isNaN(price) || price === null) {
            return '0đ';
        }
        return parseFloat(price).toLocaleString('vi-VN') + 'đ';
    }

    function updatePrice(productId, donViTinhId, quantity) {
        let unitPriceText = $('#unit-price-' + productId + '-' + donViTinhId).text().replace(/[^0-9]/g, '');
        let unitPrice = parseFloat(unitPriceText);

        let totalPrice = unitPrice * quantity;
        $('#price-' + productId + '-' + donViTinhId).text(formatPrice(totalPrice));

        updateCartSummary();
        updateCheckoutModal();

        $.ajax({
            url: '/cart/update-quantity',
            type: 'POST',
            data: { productId: productId, donViTinhId: donViTinhId, quantity: quantity },
            success: function(response) {
                if (response.success) {
                    let unitPrice = response.price;
                    $('#unit-price-' + productId + '-' + donViTinhId).text(formatPrice(unitPrice));

                    let totalPrice = unitPrice * quantity;
                    $('#price-' + productId + '-' + donViTinhId).text(formatPrice(totalPrice));

                    updateCartSummary();
                    updateCheckoutModal();
                }
            },
            error: function(xhr) {
                console.error('Error updating quantity:', xhr);
            }
        });
    }

    function updateCartSummary() {
        let originalTotal = parseFloat(/*[[${originalCartTotal}]]*/ 0);
        let directDiscount = parseFloat(/*[[${directDiscount}]]*/ 0);
        let voucherDiscount = parseFloat(/*[[${voucherDiscount}]]*/ 0);
        let totalSavings = parseFloat(/*[[${totalSavings}]]*/ 0);
        let finalTotal = parseFloat(/*[[${finalTotal}]]*/ 0);

        $('#cart-total').text(formatPrice(originalTotal));
        $('#direct-discount').text('-' + formatPrice(directDiscount));
        $('#voucher-discount').text('-' + formatPrice(voucherDiscount));
        $('#total-savings').text(formatPrice(totalSavings));
        $('#final-total').text(formatPrice(finalTotal));
    }

    function updateCheckoutModal() {
        let originalTotal = parseFloat(/*[[${originalCartTotal}]]*/ 0);
        let directDiscount = parseFloat(/*[[${directDiscount}]]*/ 0);
        let voucherDiscount = parseFloat(/*[[${voucherDiscount}]]*/ 0);
        let totalSavings = parseFloat(/*[[${totalSavings}]]*/ 0);
        let finalTotal = parseFloat(/*[[${finalTotal}]]*/ 0);

        let itemsHtml = '';
        $('input[id^="item-checkbox-"]:checked').each(function() {
            let productId = $(this).data('product-id');
            let unitId = $(this).data('unit-id');
            let quantity = parseInt($('#quantity-' + productId + '-' + unitId).val());
            let productName = $(this).closest('.cart-item').find('h6').text();
            let unitName = $('#unit-' + productId + '-' + unitId + ' option:selected').text();
            let productImage = $(this).closest('.cart-item').find('img').attr('src');
            let unitPrice = parseFloat($('#unit-price-' + productId + '-' + unitId).text().replace(/[^0-9]/g, ''));
            let itemTotalPrice = unitPrice * quantity;

            itemsHtml += `
            <div class="order-item">
                <img src="${productImage}" alt="${productName}">
                <div class="order-item-details">
                    <p><strong>${productName}</strong></p>
                    <p>Số lượng: ${quantity} | Đơn vị: ${unitName} | Giá: ${formatPrice(unitPrice)}</p>
                </div>
                <div class="order-item-price">${formatPrice(itemTotalPrice)}</div>
            </div>
        `;
        });

        $('#modal-order-items').html(itemsHtml);
        $('#modal-cart-total').text(formatPrice(originalTotal));
        $('#modal-direct-discount').text('-' + formatPrice(directDiscount));
        $('#modal-voucher-discount').text('-' + formatPrice(voucherDiscount));
        $('#modal-total-savings').text(formatPrice(totalSavings));
        $('#modal-final-total').text(formatPrice(finalTotal));
    }

    function increaseQuantity(productId, donViTinhId) {
        let input = $('#quantity-' + productId + '-' + donViTinhId);
        let quantity = parseInt(input.val()) + 1;
        input.val(quantity);
        updatePrice(productId, donViTinhId, quantity);
    }

    function decreaseQuantity(productId, donViTinhId) {
        let input = $('#quantity-' + productId + '-' + donViTinhId);
        let quantity = parseInt(input.val());
        if (quantity > 1) {
            quantity -= 1;
            input.val(quantity);
            updatePrice(productId, donViTinhId, quantity);
        }
    }

    function removeItem(cartItemId) {
        if (confirm('Bạn có chắc muốn xóa sản phẩm này khỏi giỏ hàng?')) {
            $.ajax({
                url: '/cart/remove',
                type: 'POST',
                data: { cartItemId: cartItemId },
                success: function() {
                    location.reload();
                },
                error: function(xhr) {
                    console.error('Error removing item:', xhr);
                }
            });
        }
    }

    function clearCart() {
        if (confirm('Bạn có chắc muốn xóa toàn bộ giỏ hàng?')) {
            $.ajax({
                url: '/cart/clear',
                type: 'POST',
                success: function() {
                    location.reload();
                },
                error: function(xhr) {
                    console.error('Error clearing cart:', xhr);
                }
            });
        }
    }

    function checkCartEmpty(itemCount) {
        if (itemCount === 0) {
            $('#cart-items-container').hide();
            $('#empty-cart').show();
            $('.btn-checkout').prop('disabled', true);
        } else {
            $('#cart-items-container').show();
            $('#empty-cart').hide();
            $('.btn-checkout').prop('disabled', false);
        }
    }

    $(document).ready(function() {
        let initialItemCount = /*[[${cartItems != null ? cartItems.size() : 0}]]*/ 0;
        checkCartEmpty(initialItemCount);

        $('p[id^="unit-price-"]').each(function() {
            let price = parseFloat($(this).text());
            $(this).text(formatPrice(price));
        });
        $('div[id^="price-"]').each(function() {
            let price = parseFloat($(this).text());
            $(this).text(formatPrice(price));
        });

        let cartTotal = parseFloat($('#cart-total').text());
        let directDiscount = parseFloat($('#direct-discount').text());
        let voucherDiscount = parseFloat($('#voucher-discount').text());
        let totalSavings = parseFloat($('#total-savings').text());
        let finalTotal = parseFloat($('#final-total').text());

        $('#cart-total').text(formatPrice(cartTotal));
        $('#direct-discount').text('-' + formatPrice(directDiscount));
        $('#voucher-discount').text('-' + formatPrice(voucherDiscount));
        $('#total-savings').text(formatPrice(totalSavings));
        $('#final-total').text(formatPrice(finalTotal));

        updateCartSummary();
        updateCheckoutModal();

        $('#select-all').on('change', function() {
            let isChecked = $(this).is(':checked');
            $('input[id^="item-checkbox-"]').prop('checked', isChecked);
            updateCartSummary();
            updateCheckoutModal();
        });

        $('input[id^="item-checkbox-"]').on('change', function() {
            let allChecked = $('input[id^="item-checkbox-"]').length === $('input[id^="item-checkbox-"]:checked').length;
            $('#select-all').prop('checked', allChecked);
            updateCartSummary();
            updateCheckoutModal();
        });

        // Biến để lưu trữ trạng thái ban đầu của các trường
        let originalCustomerInfo = {};
        let isEditing = false;

        // Hàm lưu trữ giá trị ban đầu của các trường
        function saveOriginalCustomerInfo() {
            originalCustomerInfo = {
                name: $('#customer-name').val(),
                phone: $('#customer-phone').val(),
                province: $('#province').val(),
                district: $('#district').val(),
                ward: $('#ward').val(),
                addressDetail: $('#customer-address-detail').val(),
                provinceName: $('#province option:selected').data('name'),
                districtName: $('#district option:selected').data('name'),
                wardName: $('#ward option:selected').data('name')
            };
        }

        // Hàm khôi phục giá trị ban đầu
        function restoreOriginalCustomerInfo() {
            $('#customer-name').val(originalCustomerInfo.name).prop('readonly', true);
            $('#customer-phone').val(originalCustomerInfo.phone).prop('readonly', true);
            $('#customer-address-detail').val(originalCustomerInfo.addressDetail).prop('readonly', true);
            $('#province').prop('disabled', true);
            $('#district').prop('disabled', true);
            $('#ward').prop('disabled', true);

            // Khôi phục danh sách tỉnh/thành phố
            if (originalCustomerInfo.province) {
                loadProvinces(originalCustomerInfo.provinceName, originalCustomerInfo.districtName, originalCustomerInfo.wardName);
            } else {
                $('#province').val('');
                $('#district').empty().append('<option value="">Chọn Quận/Huyện</option>').prop('disabled', true);
                $('#ward').empty().append('<option value="">Chọn Xã/Phường</option>').prop('disabled', true);
            }

            $('#edit-customer-info').show();
            $('#edit-controls').hide();
            isEditing = false;
        }

        // Xử lý sự kiện click nút "Chỉnh sửa"
        $('#edit-customer-info').on('click', function() {
            saveOriginalCustomerInfo();
            isEditing = true;

            // Mở các trường để chỉnh sửa
            $('#customer-name, #customer-phone, #customer-address-detail').prop('readonly', false);
            $('#province, #district, #ward').prop('disabled', false);

            // Ẩn nút "Chỉnh sửa" và hiển thị các nút "Lưu" và "Hủy"
            $(this).hide();
            $('#edit-controls').show();
        });

        // Xử lý sự kiện click nút "Lưu"
        $('#save-customer-info').on('click', function() {
            // Kiểm tra dữ liệu hợp lệ
            let isValid = true;
            $('.form-group').removeClass('invalid');

            if (!$('#customer-name').val().trim()) {
                $('#customer-name').closest('.form-group').addClass('invalid');
                isValid = false;
            }
            if (!$('#customer-phone').val().trim() || !/^\d{10,11}$/.test($('#customer-phone').val().trim())) {
                $('#customer-phone').closest('.form-group').addClass('invalid');
                isValid = false;
            }
            if (!$('#province').val()) {
                $('#province').closest('.form-group').addClass('invalid');
                isValid = false;
            }
            if (!$('#district').val()) {
                $('#district').closest('.form-group').addClass('invalid');
                isValid = false;
            }
            if (!$('#ward').val()) {
                $('#ward').closest('.form-group').addClass('invalid');
                isValid = false;
            }
            if (!$('#customer-address-detail').val().trim()) {
                $('#customer-address-detail').closest('.form-group').addClass('invalid');
                isValid = false;
            }

            if (!isValid) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Thông tin không hợp lệ',
                    text: 'Vui lòng điền đầy đủ và đúng thông tin.',
                    confirmButtonText: 'OK',
                    customClass: {
                        confirmButton: 'btn btn-primary'
                    }
                });
                return;
            }

            // Đặt lại các trường thành readonly/disabled
            $('#customer-name, #customer-phone, #customer-address-detail').prop('readonly', true);
            $('#province, #district, #ward').prop('disabled', true);

            // Hiển thị lại nút "Chỉnh sửa" và ẩn các nút "Lưu" và "Hủy"
            $('#edit-customer-info').show();
            $('#edit-controls').hide();
            isEditing = false;
        });

        // Xử lý sự kiện click nút "Hủy chỉnh sửa"
        $('#cancel-edit').on('click', function() {
            restoreOriginalCustomerInfo();
        });

        // Xử lý sự kiện click cho nút "Mua hàng"
        $('#checkout-button').on('click', function() {
            let selectedItems = $('input[id^="item-checkbox-"]:checked').length;
            if (selectedItems === 0) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Chưa chọn sản phẩm',
                    text: 'Vui lòng chọn ít nhất một sản phẩm để mua hàng.',
                    confirmButtonText: 'OK',
                    customClass: {
                        confirmButton: 'btn btn-primary'
                    }
                });
                return;
            }

            $.ajax({
                url: '/check-auth',
                type: 'GET',
                success: function(response) {
                    if (!response.authenticated) {
                        Swal.fire({
                            title: 'Đăng nhập để nhận thêm ưu đãi',
                            text: 'Vui lòng đăng nhập để nhận các ưu đãi độc quyền và hoàn tất thanh toán nhanh chóng!',
                            icon: 'info',
                            showCancelButton: true,
                            confirmButtonText: 'Đăng nhập',
                            cancelButtonText: 'Tiếp tục thanh toán',
                            buttonsStyling: false,
                            customClass: {
                                confirmButton: 'btn btn-primary me-2',
                                cancelButton: 'btn btn-secondary'
                            }
                        }).then((result) => {
                            if (result.isConfirmed) {
                                $('#loginModal').modal('show');
                            } else if (result.dismiss === Swal.DismissReason.cancel) {
                                // Hiển thị modal xác nhận đơn hàng khi chọn "Tiếp tục thanh toán"
                                $('#checkoutModal').modal('show');
                                updateCheckoutModal();
                                resetFormAndLoadProvinces();
                            }
                        });
                    } else {
                        // Người dùng đã đăng nhập, hiển thị modal xác nhận đơn hàng ngay
                        $('#checkoutModal').modal('show');
                        updateCheckoutModal();
                        resetFormAndLoadProvinces();
                    }
                },
                error: function(xhr) {
                    console.error('Error checking auth:', xhr);
                    Swal.fire({
                        icon: 'error',
                        title: 'Lỗi',
                        text: 'Đã có lỗi xảy ra. Vui lòng thử lại.',
                        confirmButtonText: 'OK',
                        customClass: {
                            confirmButton: 'btn btn-primary'
                        }
                    });
                }
            });
        });

        $('#province').on('change', function() {
            let provinceCode = $(this).val();
            if (provinceCode) {
                loadDistricts(provinceCode);
            } else {
                $('#district').empty().append('<option value="">Chọn Quận/Huyện</option>').prop('disabled', true);
                $('#ward').empty().append('<option value="">Chọn Xã/Phường</option>').prop('disabled', true);
            }
        });

        $('#district').on('change', function() {
            let districtCode = $(this).val();
            if (districtCode) {
                loadWards(districtCode);
            } else {
                $('#ward').empty().append('<option value="">Chọn Xã/Phường</option>').prop('disabled', true);
            }
        });

        $('#confirm-order').on('click', function() {
            let customerName = $('#customer-name').val().trim();
            let customerPhone = $('#customer-phone').val().trim();
            let province = $('#province').val();
            let district = $('#district').val();
            let ward = $('#ward').val();
            let addressDetail = $('#customer-address-detail').val().trim();
            let paymentMethod = $('#payment-method').val();

            $('.form-group').removeClass('invalid');

            let isValid = true;
            if (!customerName) {
                $('#customer-name').closest('.form-group').addClass('invalid');
                isValid = false;
            }
            if (!customerPhone || !/^\d{10,11}$/.test(customerPhone)) {
                $('#customer-phone').closest('.form-group').addClass('invalid');
                isValid = false;
            }
            if (!province) {
                $('#province').closest('.form-group').addClass('invalid');
                isValid = false;
            }
            if (!district) {
                $('#district').closest('.form-group').addClass('invalid');
                isValid = false;
            }
            if (!ward) {
                $('#ward').closest('.form-group').addClass('invalid');
                isValid = false;
            }
            if (!addressDetail) {
                $('#customer-address-detail').closest('.form-group').addClass('invalid');
                isValid = false;
            }

            if (!isValid) {
                return;
            }

            let provinceName = $('#province option:selected').data('name');
            let districtName = $('#district option:selected').data('name');
            let wardName = $('#ward option:selected').data('name');
            let customerAddress = `${addressDetail}, ${wardName}, ${districtName}, ${provinceName}`;

            let selectedItems = [];
            let totalAmount = 0;
            $('input[id^="item-checkbox-"]:checked').each(function() {
                let productId = $(this).data('product-id');
                let unitId = $(this).data('unit-id');
                let quantity = parseInt($('#quantity-' + productId + '-' + unitId).val());
                let priceText = $('#price-' + productId + '-' + unitId).text().replace(/[^0-9]/g, '');
                let itemTotalPrice = parseFloat(priceText);
                totalAmount += itemTotalPrice;

                selectedItems.push({
                    productId: productId,
                    donViTinhId: unitId,
                    quantity: quantity,
                    price: itemTotalPrice / quantity
                });
            });

            let orderData = {
                customerName: customerName,
                customerPhone: customerPhone,
                customerAddress: customerAddress,
                paymentMethod: paymentMethod,
                items: selectedItems,
                totalAmount: totalAmount
            };

            console.log('Order data:', orderData);

            if (paymentMethod === 'payos') {
                $.ajax({
                    url: '/thanhtoan/payos',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(orderData),
                    success: function(response) {
                        if (response.success && response.checkoutUrl) {
                            window.location.href = response.checkoutUrl;
                        } else {
                            Swal.fire({
                                icon: 'error',
                                title: 'Lỗi thanh toán',
                                text: response.message || 'Không thể tạo link thanh toán. Vui lòng thử lại.',
                                confirmButtonText: 'OK',
                                customClass: {
                                    confirmButton: 'btn btn-primary'
                                }
                            });
                        }
                    },
                    error: function(xhr) {
                        console.error('Error creating PayOS payment:', xhr);
                        let errorMessage = 'Đã có lỗi xảy ra khi tạo link thanh toán. Vui lòng thử lại.';
                        if (xhr.responseJSON && xhr.responseJSON.message) {
                            errorMessage = xhr.responseJSON.message;
                        } else if (xhr.status === 401 || xhr.status === 403) {
                            errorMessage = 'Vui lòng đăng nhập để thực hiện thanh toán.';
                        }
                        Swal.fire({
                            icon: 'error',
                            title: 'Lỗi thanh toán',
                            text: errorMessage,
                            confirmButtonText: 'OK',
                            customClass: {
                                confirmButton: 'btn btn-primary'
                            }
                        });
                    }
                });
            } else {
                $.ajax({
                    url: '/thanhtoan',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(orderData),
                    success: function(response) {
                        if (response.success) {
                            Swal.fire({
                                icon: 'success',
                                title: 'Đặt hàng thành công!',
                                text: 'Cảm ơn bạn đã đặt hàng. Bạn sẽ được chuyển đến trang xác nhận.',
                                confirmButtonText: 'OK',
                                customClass: {
                                    confirmButton: 'btn btn-primary'
                                }
                            }).then(() => {
                                window.location.href = '/order-confirmation';
                            });
                        } else {
                            Swal.fire({
                                icon: 'error',
                                title: 'Đặt hàng thất bại',
                                text: response.message || 'Đã có lỗi xảy ra. Vui lòng thử lại.',
                                confirmButtonText: 'OK',
                                customClass: {
                                    confirmButton: 'btn btn-primary'
                                }
                            });
                        }
                    },
                    error: function(xhr) {
                        console.error('Error placing order:', xhr);
                        Swal.fire({
                            icon: 'error',
                            title: 'Lỗi',
                            text: 'Đã có lỗi xảy ra. Vui lòng thử lại sau.',
                            confirmButtonText: 'OK',
                            customClass: {
                                confirmButton: 'btn btn-primary'
                            }
                        });
                    }
                });
            }

            $('#checkoutModal').modal('hide');
        });

        // Hàm reset form và tải danh sách tỉnh/thành phố
        function resetFormAndLoadProvinces() {
            $('.form-group').removeClass('invalid');
            $('#customer-name, #customer-phone, #customer-address-detail').val('').prop('readonly', true);
            $('#province, #district, #ward').val('').prop('disabled', true);
            $('#edit-customer-info').show();
            $('#edit-controls').hide();
            isEditing = false;

            // Kiểm tra nếu người dùng đã đăng nhập
            $.ajax({
                url: '/cart/default-address',
                type: 'GET',
                success: function(response) {
                    if (response.success) {
                        $('#customer-name').val(response.fullName).prop('readonly', true);
                        $('#customer-phone').val(response.phoneNumber).prop('readonly', true);
                        $('#customer-address-detail').val(response.addressDetail).prop('readonly', true);

                        let defaultCity = response.city;
                        let defaultDistrict = response.district;
                        let defaultWard = response.ward;

                        loadProvinces(defaultCity, defaultDistrict, defaultWard);
                    } else {
                        // Người dùng chưa đăng nhập hoặc không có địa chỉ mặc định
                        $('#customer-name, #customer-phone, #customer-address-detail').val('').prop('readonly', true);
                        $('#province, #district, #ward').val('').prop('disabled', true);
                        loadProvinces();
                        Swal.fire({
                            icon: 'info',
                            title: 'Thông tin địa chỉ',
                            text: 'Vui lòng nhập thông tin địa chỉ để tiếp tục thanh toán.',
                            confirmButtonText: 'OK',
                            customClass: {
                                confirmButton: 'btn btn-primary'
                            }
                        }).then(() => {
                            // Tự động kích hoạt chế độ chỉnh sửa
                            $('#edit-customer-info').trigger('click');
                        });
                    }
                },
                error: function(xhr) {
                    console.error('Error loading default address:', xhr);
                    $('#customer-name, #customer-phone, #customer-address-detail').val('').prop('readonly', true);
                    $('#province, #district, #ward').val('').prop('disabled', true);
                    loadProvinces();
                    Swal.fire({
                        icon: 'error',
                        title: 'Lỗi',
                        text: 'Không thể tải địa chỉ mặc định. Vui lòng nhập thông tin địa chỉ.',
                        confirmButtonText: 'OK',
                        customClass: {
                            confirmButton: 'btn btn-primary'
                        }
                    }).then(() => {
                        // Tự động kích hoạt chế độ chỉnh sửa
                        $('#edit-customer-info').trigger('click');
                    });
                }
            });
        }

        // Hàm lấy danh sách Tỉnh/Thành phố
        function loadProvinces(defaultCity, defaultDistrict, defaultWard) {
            $.ajax({
                url: '/cart/proxy/provinces',
                method: 'GET',
                success: function(data) {
                    $('#province').empty().append('<option value="">Chọn Tỉnh/Thành phố</option>');
                    if (Array.isArray(data) && data.length > 0) {
                        data.forEach(function(province) {
                            let isSelected = defaultCity && province.name === defaultCity ? 'selected' : '';
                            $('#province').append(`<option value="${province.code}" data-name="${province.name}" ${isSelected}>${province.name}</option>`);
                        });

                        // Nếu có tỉnh/thành phố mặc định, tải quận/huyện
                        if (defaultCity) {
                            let selectedProvinceCode = $('#province option:selected').val();
                            if (selectedProvinceCode) {
                                loadDistricts(selectedProvinceCode, defaultDistrict, defaultWard);
                            }
                        }
                    } else {
                        Swal.fire({
                            icon: 'warning',
                            title: 'Cảnh báo',
                            text: 'Danh sách tỉnh/thành phố trống. Vui lòng thử lại sau.',
                            confirmButtonText: 'OK',
                            customClass: {
                                confirmButton: 'btn btn-primary'
                            }
                        });
                    }
                },
                error: function(xhr) {
                    console.error('Error loading provinces:', xhr);
                    Swal.fire({
                        icon: 'error',
                        title: 'Lỗi',
                        text: 'Không thể tải danh sách tỉnh/thành phố. Vui lòng kiểm tra kết nối và thử lại.',
                        confirmButtonText: 'OK',
                        customClass: {
                            confirmButton: 'btn btn-primary'
                        }
                    });
                }
            });
        }

        // Hàm lấy danh sách Quận/Huyện
        function loadDistricts(provinceCode, defaultDistrict, defaultWard) {
            $.ajax({
                url: `/cart/proxy/districts/${provinceCode}`,
                method: 'GET',
                success: function(data) {
                    $('#district').empty().append('<option value="">Chọn Quận/Huyện</option>').prop('disabled', false);
                    if (data && Array.isArray(data.districts) && data.districts.length > 0) {
                        data.districts.forEach(function(district) {
                            let isSelected = defaultDistrict && district.name === defaultDistrict ? 'selected' : '';
                            $('#district').append(`<option value="${district.code}" data-name="${district.name}" ${isSelected}>${district.name}</option>`);
                        });

                        // Nếu có quận/huyện mặc định, tải xã/phường
                        if (defaultDistrict) {
                            let selectedDistrictCode = $('#district option:selected').val();
                            if (selectedDistrictCode) {
                                loadWards(selectedDistrictCode, defaultWard);
                            }
                        } else {
                            $('#ward').empty().append('<option value="">Chọn Xã/Phường</option>').prop('disabled', true);
                        }
                    } else {
                        $('#district').prop('disabled', true);
                        Swal.fire({
                            icon: 'warning',
                            title: 'Cảnh báo',
                            text: 'Danh sách quận/huyện trống. Vui lòng chọn tỉnh/thành phố khác.',
                            confirmButtonText: 'OK',
                            customClass: {
                                confirmButton: 'btn btn-primary'
                            }
                        });
                    }
                },
                error: function(xhr) {
                    console.error('Error loading districts:', xhr);
                    $('#district').prop('disabled', true);
                    Swal.fire({
                        icon: 'error',
                        title: 'Lỗi',
                        text: 'Không thể tải danh sách quận/huyện. Vui lòng thử lại.',
                        confirmButtonText: 'OK',
                        customClass: {
                            confirmButton: 'btn btn-primary'
                        }
                    });
                }
            });
        }

        // Hàm lấy danh sách Xã/Phường
        function loadWards(districtCode, defaultWard) {
            $.ajax({
                url: `/cart/proxy/wards/${districtCode}`,
                method: 'GET',
                success: function(data) {
                    $('#ward').empty().append('<option value="">Chọn Xã/Phường</option>').prop('disabled', false);
                    if (data && Array.isArray(data.wards) && data.wards.length > 0) {
                        data.wards.forEach(function(ward) {
                            let isSelected = defaultWard && ward.name === defaultWard ? 'selected' : '';
                            $('#ward').append(`<option value="${ward.code}" data-name="${ward.name}" ${isSelected}>${ward.name}</option>`);
                        });
                    } else {
                        $('#ward').prop('disabled', true);
                        Swal.fire({
                            icon: 'warning',
                            title: 'Cảnh báo',
                            text: 'Danh sách xã/phường trống. Vui lòng chọn quận/huyện khác.',
                            confirmButtonText: 'OK',
                            customClass: {
                                confirmButton: 'btn btn-primary'
                            }
                        });
                    }
                },
                error: function(xhr) {
                    console.error('Error loading wards:', xhr);
                    $('#ward').prop('disabled', true);
                    Swal.fire({
                        icon: 'error',
                        title: 'Lỗi',
                        text: 'Không thể tải danh sách xã/phường. Vui lòng thử lại.',
                        confirmButtonText: 'OK',
                        customClass: {
                            confirmButton: 'btn btn-primary'
                        }
                    });
                }
            });
        }
    });
</script>
</body>
</html>